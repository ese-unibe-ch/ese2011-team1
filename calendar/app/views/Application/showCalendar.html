#{extends 'main.html' /}
#{set title:'Home' /}
<header>
	<h1>${user.getName()}'s ${calendar.getName()} Calendar
<!-- TODO DELETE FROM HERE USED FOR TESTING-->
	#{if message}
		<font style = "font-size: 30px; color: red;">${message}</font>
	#{/if}
<!-- TO HERE -->
		%{
		//Add transparent star (normal calendar) or yellow star (faved calendar)
		if (me != user) {
			if (faved) {
				%}<a href="@{Application.removeObserve(user.getName(), calendar.getId(), activeDate.toString('dd/MM/yyyy, HH:mm'), message)}">%{
				out.println('<img src="/public/images/star_fav.png" border=0>');
			}
			else {
				%}<a href="@{Application.addObserve(user.getName(), calendar.getId(), activeDate.toString('dd/MM/yyyy, HH:mm'), message)}">%{
				out.println('<img src="/public/images/star.png" border=0>');
			}
		}
		%}
	</a>
	
	</h1>
	<p> Month: ${activeDate.toString("MMM")} ${activeDate.getYear().toString()} </p>
</header>

<body>
	<div id="nextMonth">
		<a href="@{Application.showCalendar(calendar.getId(),user.getName(), nextMonth.toString('dd/MM/yyyy, HH:mm'), activeDate.getDayOfMonth())}"> next </a>
	</div>
	
	<div id="prevousMonth">
		<a href="@{Application.showCalendar(calendar.getId(), user.getName(), prevMonth.toString('dd/MM/yyyy, HH:mm'), activeDate.getDayOfMonth())}"> previous </a>
	</div>
	
	<table id="calendar">
		<tr>
			<td class="title"> Mo </td>
			<td class="title"> Di </td>
			<td class="title"> Mi </td>	
			<td class="title"> Do </td>	
			<td class="title"> Fr </td>	
			<td class="title"> Sa </td>	
			<td class="title"> So </td>	
		</tr>
		%{ 
		//System.out.println("Tage berechnen.");
		
			int tmp = 1;
			int counter = 1;
			int year = activeDate.getYear();
			int month = activeDate.getMonthOfYear();
			
			for(int i = 0; i < 6; i++){
				
				out.println('<tr>');
				for(int j = 0; j < 7; j++){
				
					// gebe hier date of month aus
					// 1. vorzellen(leer), 2. erster bis letzter tag, 3. fill-in
					
					if (tmp  < bound){
						out.println('<td class="entry"> - </td>');
					} 
					else if(counter <= bound2)
					{
					
					// Layout of day can be seperated into 3 categories:
					// 1 - today
						if (counter  == today.getDayOfMonth() 
								&& month == today.getMonthOfYear()
							 	&& year == today.getYear()) 
							{out.println('<td class="today"> ');}
						
					// 2 - selected
						else if (counter == activeDate.getDayOfMonth()) {
							out.println('<td class="selected"> ');
						}
						
					// 3 - normal day
						else {
							out.println('<td class="entry"> ');
						}
						//System.out.println("vor calendar.hasEventOnDate ");
						if(calendar.hasEventOnDate(counter, month, year, me)){
						//System.out.println("im calendar.hasEventOnDate ");
							%} 
							<a href="@{Application.showCalendar(calendar.getId(), user.getName(), activeDate.toString('dd/MM/yyyy, HH:mm'), counter)}"> ${counter}</a>
							%{
						//System.out.println("nach calendar.hasEventOnDate ");
						}
						else {
							out.println(counter+'</td>');	
						}
						counter++;
					}
					else {
						out.println('<td class="entry"> - </td>');
					}
					tmp++;
				}
				out.println('</tr>');
			}
			//System.out.println("Tage berechnen okay.");
		%} 
	
	</table>
	
	%{
	if (me == user) {
	%}
	
	<form name="calendarform">
	<!-- observed calendars -->
	%{
		int c=0;
		int space = 360;
		int interval = (int)(space/(Math.max(shownObservedCalendars.size()-1,1)));
	%}
	
	#{list items:observedCalendars, as:'cal'}
		
		<input type="checkbox" name="${cal.getName()}" id="${cal.id}" value="${cal.getName()}" onclick="changeSelection(this)" 
		%{
		//if observable calendar is shown, display checkbox as checked
		boolean statementClosed = false;
		 if (shownObservedCalendars != null) {

			for (int i=0; i<shownObservedCalendars.size(); i++) {
				if (shownObservedCalendars.contains(cal.id)) {
					out.print('checked="true"');
					
					//Color observed calendars
					int col = interval*c;
		 			out.print('><font style="color: hsl(' + col + ',100%, 50%)">&#10026;</font> '+cal.getName()+'<br>');
		 			c++;
					statementClosed = true;
					break;
				}
			}
		 }
		 
		 if (!statementClosed) {
			out.print('> '+cal.getName()+'<br>');
		 }
		 
		%}
	#{/list}
	</form>
	%{
	}
	%}
	
	<div style="clear:both"></div>

	<table id="events">
			<h2>${user.getName()}'s events of the ${activeDate.toString("dd-MM-yyyy")} </h2>
			#{list items:eventsOfDate, as:'event'}
				<p>
					<!-- <li> -->
							<!-- Color for observed Events -->
							#{if me != event.getOwner()} 
							%{
							int space = 360;
							int interval = (int)(space/(Math.max(shownObservedCalendars.size()-1,1)));
							//System.out.println("interval = "+interval+", calenderID = "+event.getCalendarId()+", found at = "+shownObservedCalendars.indexOf(event.getCalendarId()));
							col = interval*(shownObservedCalendars.indexOf(event.getCalendarId())-1);
							out.print('<font style="color: hsl(' + col + ',100%, 50%)">&#10026;</font>');
							%}
							<b>Owner:</b>${event.getOwner().getName()} 
							#{/if}
								
							#{if user==me} 
								#{if me==event.getOwner() || event.isPublic()}<b>Event name:</b>${event.getName()} #{/if},
								
								<!-- Why is this me==event.getOwner()?? this displays 'busy' for all owned events! -->
								#{if me==event.getOwner() || event.isBusy()} <b>Busy</b> #{/if},  
								<b>from:</b>${event.getStart().toString("dd/MM/yyyy, HH:mm")}  ,<b>to:</b>${event.getEnd().toString("dd/MM/yyyy, HH:mm")} 
								    
								#{if me==event.getOwner() || event.isPublic()}
									<b>visibility</b>:${event.getVisibility()} 
									<b>Repeating:</b>${event.isRepeating()}  
									<b>Description</b>:${event.getDescription()} <br>
								#{/if}
							#{/if} <br>
							
							
							<b>Repeating:</b>${event.isRepeating()}
							<b>Description</b>:${event.getDescription()} <br>
							#{if user == me && me==event.getOwner() && !user.isBirthday(event)}
								<b><a href="@{Application.editEvent(event.getId(), calendar.getId(), me.getName(), activeDate.toString('dd/MM/yyyy, HH:mm'))}"> Edit </a></b> <br>
								<b><a href="@{Application.removeEvent(calendar.getId(), event.getId(), activeDate.toString('dd/MM/yyyy, HH:mm'))}"> Remove </a></b> <br>
								#{if event.isRepeating()}
									<b><a href="@{Application.removeRepeatingEvents(calendar.getId(), event.getId(), activeDate.toString('dd/MM/yyyy, HH:mm'))}"> Remove All Repeating </a></b><br>  
									<b> <a href="@{Application.cancelEventRepetition(calendar.getId(), event.getId(), activeDate.toString('dd/MM/yyyy, HH:mm'))}">Cancel Repetition from here </a></b>
								#{/if}
							#{/if}
							#{if event.getOwner() == me && event.isOpen() || event.isPublic() && event.isOpen()}
							<b>Attending: </b> ${event.getAttendingUsers()}<br>
								#{if event.userIsAttending(me.getName())}
									You are attending! <b><a href="@{Application.removeUserFromEvent(me.getName(), calendar.getId(), event.getId(), activeDate.toString('dd/MM/yyyy, HH:mm'))}"> No longer Attend </a></b><br>
								#{/if}
								#{else}
									<b><a href="@{Application.addUserToEvent(user.getName(), calendar.getId(), event.getId(), activeDate.toString('dd/MM/yyyy, HH:mm'))}"> Attend </a></b><br>
								#{/else}  
							#{/if}
					<br>
					<!-- </li> --> 
				</p>
			#{/list}
	</table>

	<div id="Nav">
		#{if user==me} 
 			<a href="@{Application.addEvent(calendar.getId(), me.getName(), activeDate.toString('dd/MM/yyyy, HH:mm'))}"> New Event</a>  <br>
		#{/if}
	</div>
	
<form name="hiddenform" action="@{Application.changeObservedCalendars()}">
<input type="hidden" name="calID" value="" />
<input type="hidden" name="chk" value="" />

<input type="hidden" name="username" value="${user.getName()}" />
<input type="hidden" name="calendarId" value="${calendar.getId()}" />
<input type="hidden" name="s_activeDate" value="${activeDate.toString('dd/MM/yyyy, HH:mm')}" />
<input type="hidden" name="message" value="${message}" />
</form>

<!-- Some Javascript to change observed calendars-->
<script type="text/javascript">
function changeSelection(boxName) {
	document.hiddenform.calID.value = boxName.id;
	
	if (boxName.checked == true) {
		document.hiddenform.chk.value = "true";
		alert("Added to view.");
	}
	else {
		document.hiddenform.chk.value = "false";
		alert("Removed from view.");
	}

	document.hiddenform.submit();
} 
</script>
	
</body>	

<a href="@{Application.showCalendarList(user.getName(), activeDate.toString('dd/MM/yyyy, HH:mm'))}">Back</a>
<a href="@{Application.index()}">Home</a>
<a href="@{Secure.logout()}">Log out</a>